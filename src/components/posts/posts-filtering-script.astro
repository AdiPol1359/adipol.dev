<script>
	import { POSTS_SECTION_LIST_ID } from './posts-section/posts-section.constants';
	import { SEARCH_FORM_INPUT_ID } from './search-form/search-form.constants';
	import { TAGS_SECTION_LIST_ID } from './tags-section/tags-section.constants';

	const postsSectionList = document.getElementById(POSTS_SECTION_LIST_ID);
	const tagsSectionList = document.getElementById(TAGS_SECTION_LIST_ID);
	const searchFormInput = document.getElementById(SEARCH_FORM_INPUT_ID);

	const posts = Array.from(postsSectionList?.querySelectorAll('article') ?? []);
	const tags = Array.from(tagsSectionList?.querySelectorAll('div') ?? []);

	const synchronizePostsList = (newPosts: HTMLElement[]) => {
		if (!postsSectionList) return;

		postsSectionList.innerHTML = '';

		newPosts.forEach(post => {
			const li = document.createElement('li');

			li.appendChild(post);
			postsSectionList.appendChild(li);
		});
	};

	searchFormInput?.addEventListener('input', ({ target }) => {
		if (!(target instanceof HTMLInputElement)) return;

		const value = target.value.toLowerCase();

		const filteredPosts = posts.filter(post => {
			const title = post.getAttribute('data-title')?.toLowerCase() ?? '';
			const introduction =
				post.getAttribute('data-introduction')?.toLowerCase() ?? '';

			return title.includes(value) || introduction.includes(value);
		});

		synchronizePostsList(filteredPosts);
	});

	tagsSectionList?.addEventListener('input', () => {
		const selectedTags = tags
			.filter(tag => tag.querySelector('input')?.checked)
			.map(tag => tag.getAttribute('data-label')?.toLowerCase() ?? '');

		const filteredPostsByTags = posts.filter(post => {
			const tagsAttribute = post.getAttribute('data-tags') ?? '';
			const tags = tagsAttribute.split(',');

			return tags.some(tag => selectedTags.includes(tag.toLowerCase()));
		});

		const filteredPosts = selectedTags.length ? filteredPostsByTags : posts;

		synchronizePostsList(filteredPosts);
	});
</script>
